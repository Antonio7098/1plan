# Sprint SPR-004 — Observability & Guardrails

Establish structured logs, metrics, rate limits, error contracts, and security baseline.

## Meta
- Sprint ID: SPR-004
- Status: done
- Start date: 2025-08-20
- End date: 2025-08-20
- Links: [Overview](./overview.md) · [PRD](../../planning/prd.md) · [Technical Overview](../../planning/technical-overview.md) · [Features CSV](../features.csv)

## Objectives (Tick when achieved)
- [x] Structured logs with requestId, route, status, latency
- [x] Basic metrics (counters/timers) and p95 dashboards (doc/config) — see [p95 guide](../metrics/p95.md)
- [x] Rate limiting (per token/IP) with 429 + Retry-After
- [x] Error format: RFC7807 Problem+JSON
- [x] Security: Helmet, CORS policy, payload limits

## Planned Tasks
- [x] Pino logger with requestId middleware
- [x] Metrics hook (histograms)
- [x] Doc: how to view p95 in Prometheus/Grafana — [p95 guide](../metrics/p95.md)
- [x] Implement limiter with configuration
- [x] Consistent error mapper to Problem+JSON
- [x] Add Helmet, CORS, size limits

### Stretch Goals (defer to SPR-005)
- [ ] SLI/SLO definitions with error budgets
- [ ] Alerting runbooks with escalation procedures
- [ ] Performance profiling and APM integration
- [ ] Log aggregation and search (ELK/Grafana)
- [ ] Synthetic monitoring and uptime checks
- [ ] Cost monitoring and budget alerts
- [ ] Business metrics (user engagement, feature usage)
- [ ] Distributed tracing with OpenTelemetry

## Scope
In scope: logging, metrics, rate limiting, error handling, security

Out of scope: tracing systems (later)

## Features in this Sprint
- [x] FEAT-014 — Observability: Structured Logs & Metrics (docs added)
- [x] FEAT-013 — Rate Limiting (per token/IP)
- [x] FEAT-015 — Error Handling (RFC7807 Problem+JSON)
- [x] FEAT-030 — Security Baseline (Helmet CORS)

## Acceptance Criteria
- [x] Logs include requestId and latency
- [x] 429 returns Retry-After
- [x] Errors conform to Problem+JSON; examples in docs
- [x] /metrics endpoint exposes Prometheus metrics; doc on how to view p95 — [p95 guide](../metrics/p95.md)
- [x] Security headers present (Helmet) and CORS policy enforced

### Problem+JSON Example
```json
{
  "type": "https://1plan.dev/errors/rate-limit-exceeded",
  "title": "Rate Limit Exceeded",
  "status": 429,
  "statusCode": 429,
  "error": "Too Many Requests",
  "detail": "Rate limit exceeded, retry in 1s",
  "instance": "/api/v1/documents",
  "requestId": "<uuid>"
}
```

## Risks & Mitigations
- Risk: noisy logs · Mitigation: levels and sampling guidance

## QA & Testing
- [ ] Unit tests for error mapper and limiter
- [ ] Manual check: metrics emitted and documented
- [x] Integration test: limiter returns 429 + Retry-After
- [x] CORS/helmet headers verified in e2e smoke
