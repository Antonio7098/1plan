# Sprint SPR-004 — Observability & Guardrails

Establish structured logs, metrics, rate limits, error contracts, and security baseline.

## Meta
- Sprint ID: SPR-004
- Status: planned
- Start date: <YYYY-MM-DD>
- End date: <YYYY-MM-DD>
- Links: [Overview](./overview.md) · [PRD](../../planning/prd.md) · [Technical Overview](../../planning/technical-overview.md) · [Features CSV](../features.csv)

## Objectives (Tick when achieved)
- [ ] Structured logs with requestId, route, status, latency
- [ ] Basic metrics (counters/timers) and p95 dashboards (doc/config)
- [ ] Rate limiting (per token/IP) with 429 + Retry-After
- [ ] Error format: RFC7807 Problem+JSON
- [ ] Security: Helmet, CORS policy, payload limits

## Planned Tasks
- [ ] Pino logger with requestId middleware
- [ ] Metrics hook (histograms) + doc how to view
- [ ] Implement limiter with configuration
- [ ] Consistent error mapper to Problem+JSON
- [ ] Add Helmet, CORS, size limits

## Scope
In scope: logging, metrics, rate limiting, error handling, security

Out of scope: tracing systems (later)

## Features in this Sprint
- [ ] FEAT-014 — Observability: Structured Logs & Metrics
- [ ] FEAT-013 — Rate Limiting (per token/IP)
- [ ] FEAT-015 — Error Handling (RFC7807 Problem+JSON)
- [ ] FEAT-011 — RequestId Propagation End-to-End
- [ ] FEAT-030 — Security Baseline (Helmet CORS)
- [ ] FEAT-034 — SLOs & Alerts (doc + config)

## Acceptance Criteria
- [ ] Logs include requestId and latency
- [ ] 429 returns Retry-After
- [ ] Errors conform to Problem+JSON; examples in docs

## Risks & Mitigations
- Risk: noisy logs · Mitigation: levels and sampling guidance

## QA & Testing
- [ ] Unit tests for error mapper and limiter
- [ ] Manual check: metrics emitted and documented
