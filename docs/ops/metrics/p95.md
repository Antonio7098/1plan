# Viewing p95 Latency with Prometheus/Grafana

This guide shows how to compute p95 HTTP latency from the API's Prometheus metrics and visualize it in Grafana.

## Endpoint
- Metrics are exposed at: `GET /metrics`
- Content-Type: `text/plain; version=0.0.4`

Example:
```bash
curl -s http://localhost:3000/metrics | head -n 40
```

## Metric names and labels
From `api/src/lib/metrics.ts`:
- Histogram: `http_request_duration_seconds{method,route,status_code}`
  - Buckets: 0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10
- Counter: `http_requests_total{method,route,status_code}`

## PromQL queries

- Overall p95 across all routes/methods (5-min window):
```promql
histogram_quantile(
  0.95,
  sum(rate(http_request_duration_seconds_bucket[5m])) by (le)
)
```

- p95 by route (top-level):
```promql
histogram_quantile(
  0.95,
  sum(rate(http_request_duration_seconds_bucket[5m])) by (le, route)
)
```

- p95 by route and method:
```promql
histogram_quantile(
  0.95,
  sum(rate(http_request_duration_seconds_bucket[5m])) by (le, route, method)
)
```

- p95 for a specific route (e.g., `/api/v1/documents`):
```promql
histogram_quantile(
  0.95,
  sum by (le) (
    rate(http_request_duration_seconds_bucket{route="/api/v1/documents"}[5m])
  )
)
```

- Request volume (per route):
```promql
sum(rate(http_requests_total[5m])) by (route)
```

## Grafana panel (quick setup)
1. Add a Time series panel.
2. Query: use one of the p95 PromQL queries above.
3. Unit: seconds (s).
4. Legend: set to `{{route}} {{method}}` if grouping by both.
5. Optional: add a threshold for SLO target (e.g., 0.3s).

## Notes
- The server records metrics via `observeRequest()` in `api/src/server.ts` `onResponse` hook.
- Label `route` is derived from Fastify's route pattern when available; otherwise the request URL.
- Buckets are seconds; p95 results are also in seconds.
